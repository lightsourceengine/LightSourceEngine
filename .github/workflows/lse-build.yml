name: lse-build

on:
  push:
    branches:
      - master

env:
  npm_config_lse_install_opts: --jobs max
  npm_config_lse_enable_native_tests: 1

jobs:
  build-job:
    if: github.event_name == 'push' && contains(toJson(github.event.commits), '[ci skip]') == false
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        os: [ windows-2019, ubuntu-18.04, macos-10.15 ]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Install Node
        uses: actions/setup-node@v1
        with:
          node-version: 16.0.0

      - name: Linux Packages
        if: contains(matrix.os, 'ubuntu')
        uses: ./.github/actions/apt-get
        with:
          ppa: 'ubuntu-toolchain-r-test'
          packages: g++-8 gcc-8

      - name: Use GCC 8
        if: contains(matrix.os, 'ubuntu')
        uses: ./.github/actions/use-gcc-8

      - name: Yarn Cache
        uses: egordm/gha-yarn-node-cache@v1

      - name: Build
        run: yarn --force

      - name: CPP Lint
        if: contains(matrix.os, 'windows') == false
        run: yarn run cpplint
        working-directory: packages/@lse/core

      - name: JS Test (+ JS Lint)
        run: yarn run test

      - name: Documentation
        run: yarn run jsdoc
